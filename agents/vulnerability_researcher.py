from crewai import Agent, Task
from utils.exa_client import exa_client
from langchain_groq import ChatGroq

llm = ChatGroq(temperature=0, model_name="llama3-70b-8192")

def fetch_latest_cves():
    result = exa_client.search_and_contents("Latest CVEs and security vulnerabilities 2024", summary=True)
    cve_list = []
    if result.results:
        for item in result.results[:5]:  # top 5 CVEs
            cve_list.append({
                "title": getattr(item, "title", "No Title"),
                "url": getattr(item, "url", "#"),
                "published_date": getattr(item, "published_date", "Unknown Date"),
                "summary": getattr(item, "summary", "No Summary"),
            })
    return cve_list

vulnerability_researcher = Agent(
    role="Vulnerability Researcher",
    goal="Identify latest software vulnerabilities.",
    backstory="You're a cybersecurity researcher specializing in vulnerability analysis and threat mitigation.",
    verbose=True,
    allow_delegation=False,
    llm=llm,
    max_iter=5,
    memory=True,
)

vulnerability_research_task = Task(
    description="Fetch and analyze latest CVEs.",
    expected_output="Structured list of newly discovered CVEs and their impact.",
    agent=vulnerability_researcher,
    callback=lambda inputs: fetch_latest_cves(),
)